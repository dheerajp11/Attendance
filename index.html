<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f2f2f2;
    }
    h2 {
      text-align: center;
    }
    .calendar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .month {
      background: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .month h3 {
      text-align: center;
    }
    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      font-size: 12px;
    }
    .day {
      padding: 10px;
      background: #eee;
      text-align: center;
      border-radius: 6px;
    }
    .sunday {
      color: red;
    }
    .selected {
      background: green;
      color: white;
    }
    .leave {
      background: orange;
      color: white;
    }
    .absent {
      background: red;
      color: white;
    }
    .button-group {
      margin-top: 10px;
      display: flex;
      justify-content: space-around;
    }
    .hidden {
      display: none;
    }
    #locationStatus {
      margin: 10px 0;
      font-size: 14px;
      color: green;
    }
  </style>
</head>
<body>
  <h2>üìÖ Mobile Attendance (2024-2025)</h2>
  <div id="locationStatus">üìç Checking Location...</div>
  <div class="calendar" id="calendar"></div>

  <script>
    const allowedLat = 26.8262645;
    const allowedLng = 80.9260447;
    let withinRange = false;

    function isSunday(date) {
      return new Date(date).getDay() === 0;
    }

    function generateCalendar(year) {
      const calendar = document.getElementById("calendar");
      for (let month = 0; month < 12; month++) {
        const monthDiv = document.createElement("div");
        monthDiv.className = "month";
        const monthName = new Date(year, month).toLocaleString("default", { month: "long" });
        monthDiv.innerHTML = `<h3>${monthName} ${year}</h3>`;
        const daysDiv = document.createElement("div");
        daysDiv.className = "days";

        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const dateObj = new Date(dateStr);
          const dayDiv = document.createElement("div");
          dayDiv.className = "day";
          if (dateObj.getDay() === 0) dayDiv.classList.add("sunday");
          dayDiv.textContent = d;
          dayDiv.addEventListener("click", () => handleDayClick(dateStr, dayDiv));
          daysDiv.appendChild(dayDiv);
        }

        monthDiv.appendChild(daysDiv);
        calendar.appendChild(monthDiv);
      }
    }

    function handleDayClick(date, element) {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentTime = currentHour * 60 + currentMinute;

      if (!withinRange) {
        alert("üìç You are not at the authorized location.");
        return;
      }

      if (currentTime < 540 || currentTime > 580) {
        alert("‚è∞ Attendance allowed between 9:00 AM and 9:40 AM only.");
        return;
      }

      if (localStorage.getItem("att_" + date)) {
        alert("‚úÖ Attendance already submitted for this date on this device.");
        return;
      }

      const name = prompt("Enter your Name:");
      const atr = prompt("Enter your ATR No:");
      const status = prompt("Enter Status (P=Present, A=Absent, L=Leave):").toUpperCase();

      if (!["P", "A", "L"].includes(status)) {
        alert("‚ùå Invalid Status");
        return;
      }

      let statusText = "";
      if (status === "P") {
        element.classList.add("selected");
        statusText = "Present";
      } else if (status === "A") {
        element.classList.add("absent");
        statusText = "Absent";
      } else {
        element.classList.add("leave");
        statusText = "Leave";
      }

      localStorage.setItem("att_" + date, JSON.stringify({ name, atr, status, date }));

      const msg = `üìÖ *Attendance Marked*\nüë§ Name: ${name}\nüÜî ATR: ${atr}\nüìå Date: ${date}\n‚úÖ Status: ${statusText}`;
      const token = "7850268206:AAESJ-AMkx23om4Yt_H3mxnXH0gKNtv1Q3A";
      const chat_id = "1977431559";
      fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ chat_id, text: msg, parse_mode: "Markdown" }),
      });
    }

    function checkLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          const distance = Math.sqrt(Math.pow(latitude - allowedLat, 2) + Math.pow(longitude - allowedLng, 2));
          withinRange = distance < 0.01;
          document.getElementById("locationStatus").textContent = withinRange
            ? "‚úÖ Location Verified"
            : "‚ùå Out of range location";
        }, err => {
          document.getElementById("locationStatus").textContent = "‚ùå Location access denied.";
        });
      } else {
        document.getElementById("locationStatus").textContent = "‚ùå Geolocation not supported.";
      }
    }

    generateCalendar(2024);
    generateCalendar(2025);
    checkLocation();
  </script>
</body>
</html>
